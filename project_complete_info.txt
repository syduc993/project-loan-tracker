================================================================================
THÃ”NG TIN Dá»° ÃN HOÃ€N CHá»ˆNH
================================================================================
Thá»i gian táº¡o: 2025-10-23 17:36:14
ThÆ° má»¥c gá»‘c: d:\Atino\extension\project-loan-tracker
================================================================================

ğŸ“ Cáº¤U TRÃšC THU Má»¤C
--------------------------------------------------
â”œâ”€â”€ ğŸ“ src/
â”‚   â”œâ”€â”€ ğŸ“ core/
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ app.py
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ config.py
â”‚   â”‚   â””â”€â”€ ğŸ“„ templating.py
â”‚   â”œâ”€â”€ ğŸ“ routes/
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ disbursement_plans.py
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ disbursements.py
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ invoices.py
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ pages.py
â”‚   â”‚   â””â”€â”€ ğŸ“„ suppliers.py
â”‚   â”œâ”€â”€ ğŸ“ schemas/
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ __init__.py
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ disbursement.py
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ disbursement_plan.py
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ invoice.py
â”‚   â”‚   â””â”€â”€ ğŸ“„ supplier.py
â”‚   â”œâ”€â”€ ğŸ“ services/
â”‚   â”‚   â””â”€â”€ ğŸ“ database/
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ base.py
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ disbursement.py
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ disbursement_plan.py
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ invoice.py
â”‚   â”‚       â”œâ”€â”€ ğŸ“„ schema.py
â”‚   â”‚       â””â”€â”€ ğŸ“„ supplier.py
â”‚   â””â”€â”€ ğŸ“ utils/
â”‚       â””â”€â”€ ğŸ“„ interest_calculator.py
â”œâ”€â”€ ğŸ“ static/
â”‚   â”œâ”€â”€ ğŸ“ css/
â”‚   â”‚   â””â”€â”€ ğŸ“„ style.css
â”‚   â””â”€â”€ ğŸ“ js/
â”‚       â”œâ”€â”€ ğŸ“ ui/
â”‚       â”‚   â”œâ”€â”€ ğŸ“„ common.js
â”‚       â”‚   â”œâ”€â”€ ğŸ“„ disbursementUI.js
â”‚       â”‚   â”œâ”€â”€ ğŸ“„ invoiceUI.js
â”‚       â”‚   â”œâ”€â”€ ğŸ“„ planUI.js
â”‚       â”‚   â””â”€â”€ ğŸ“„ supplierUI.js
â”‚       â”œâ”€â”€ ğŸ“„ api.js
â”‚       â”œâ”€â”€ ğŸ“„ main.js
â”‚       â””â”€â”€ ğŸ“„ state.js
â”œâ”€â”€ ğŸ“ templates/
â”‚   â”œâ”€â”€ ğŸ“„ base.html
â”‚   â””â”€â”€ ğŸ“„ home.html
â”œâ”€â”€ ğŸ“„ Dockerfile
â”œâ”€â”€ ğŸ“„ Get detail code.ipynb
â”œâ”€â”€ ğŸ“„ main.py
â”œâ”€â”€ ğŸ“„ project_complete_info.txt
â”œâ”€â”€ ğŸ“„ README.md
â””â”€â”€ ğŸ“„ requirements.txt


ğŸ“„ DANH SÃCH Táº¤T Cáº¢ FILE
--------------------------------------------------
Dockerfile (217 bytes)
Get detail code.ipynb (9476 bytes)
main.py (151 bytes)
project_complete_info.txt (0 bytes)
README.md (1692 bytes)
requirements.txt (130 bytes)
src\core\app.py (1146 bytes)
src\core\config.py (210 bytes)
src\core\templating.py (347 bytes)
src\routes\disbursement_plans.py (3333 bytes)
src\routes\disbursements.py (2610 bytes)
src\routes\invoices.py (2698 bytes)
src\routes\pages.py (556 bytes)
src\routes\suppliers.py (2489 bytes)
src\schemas\__init__.py (0 bytes)
src\schemas\disbursement.py (2137 bytes)
src\schemas\disbursement_plan.py (1036 bytes)
src\schemas\invoice.py (2150 bytes)
src\schemas\supplier.py (374 bytes)
src\services\database\base.py (1901 bytes)
src\services\database\disbursement.py (7150 bytes)
src\services\database\disbursement_plan.py (1557 bytes)
src\services\database\invoice.py (2062 bytes)
src\services\database\schema.py (2879 bytes)
src\services\database\supplier.py (1409 bytes)
src\utils\interest_calculator.py (3692 bytes)
static\css\style.css (5784 bytes)
static\js\api.js (2299 bytes)
static\js\main.js (6790 bytes)
static\js\state.js (405 bytes)
static\js\ui\common.js (4090 bytes)
static\js\ui\disbursementUI.js (4913 bytes)
static\js\ui\invoiceUI.js (5810 bytes)
static\js\ui\planUI.js (3881 bytes)
static\js\ui\supplierUI.js (2797 bytes)
templates\base.html (2243 bytes)
templates\home.html (5153 bytes)

Tá»•ng cá»™ng: 37 file

ğŸ’» Ná»˜I DUNG Táº¤T Cáº¢ FILE CODE
================================================================================

============================================================
FILE: main.py
============================================================
import uvicorn
from src.core.app import app

if __name__ == "__main__":
    uvicorn.run("src.core.app:app", host="0.0.0.0", port=8000, reload=True)
============================================================

============================================================
FILE: project_complete_info.txt
============================================================

============================================================

============================================================
FILE: README.md
============================================================
-- Báº£ng 1: NhÃ  Cung Cáº¥p
CREATE TABLE suppliers (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    name TEXT NOT NULL,
    contact_info TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Báº£ng 2: Káº¿ Hoáº¡ch Giáº£i NgÃ¢n
CREATE TABLE disbursement_plans (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    name TEXT NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Báº£ng 3: HÃ³a ÄÆ¡n (liÃªn káº¿t vá»›i Káº¿ hoáº¡ch)
CREATE TABLE invoices (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    plan_id BIGINT REFERENCES disbursement_plans(id) ON DELETE CASCADE,
    supplier_id BIGINT REFERENCES suppliers(id) ON DELETE SET NULL,
    invoice_number TEXT NOT NULL,
    issue_date DATE NOT NULL,
    total_value NUMERIC(15, 2) NOT NULL,
    status TEXT DEFAULT 'ChÆ°a thanh toÃ¡n',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Báº£ng 4: CÃ¡c Láº§n Giáº£i NgÃ¢n (liÃªn káº¿t vá»›i Káº¿ hoáº¡ch)
-- THAY Äá»”I QUAN TRá»ŒNG: LiÃªn káº¿t trá»±c tiáº¿p vá»›i plan_id
CREATE TABLE disbursements (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    plan_id BIGINT REFERENCES disbursement_plans(id) ON DELETE CASCADE,
    
    -- Káº¿ hoáº¡ch vÃ  thá»±c táº¿
    planned_date DATE,
    planned_amount NUMERIC(15, 2),
    actual_date DATE,
    actual_amount NUMERIC(15, 2),

    -- ThÃ´ng tin tÃ i chÃ­nh & kháº¿ Æ°á»›c
    bank_name TEXT,
    loan_contract_number TEXT,
    loan_term_months INT,
    loan_interest_rate REAL,
    interest_amount NUMERIC(15, 2),
    interest_due_date DATE,
    principal_due_date DATE,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);


============================================================

============================================================
FILE: requirements.txt
============================================================
fastapi==0.104.1
uvicorn[standard]==0.24.0
pydantic-settings==2.0.3
jinja2==3.1.2
sqlalchemy[asyncio]==2.0.23
asyncpg==0.27.0
============================================================

============================================================
FILE: src\core\app.py
============================================================
# File: src/core/app.py (ÄÃƒ Sá»¬A Lá»–I)

from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles
from pathlib import Path

# Import routers
from src.routes import suppliers, invoices, pages, disbursement_plans, disbursements

# Import Ä‘á»‘i tÆ°á»£ng templates tá»« file má»›i
from .templating import templates 

app = FastAPI(title="Project Loan Tracker")

# XÃ¡c Ä‘á»‹nh Ä‘Æ°á»ng dáº«n thÆ° má»¥c gá»‘c
BASE_DIR = Path(__file__).resolve().parent.parent.parent

# 1. Mount thÆ° má»¥c static
app.mount("/static", StaticFiles(directory=BASE_DIR / "static"), name="static")



# 3. Gáº¯n cÃ¡c API Routers (giá»¯ nguyÃªn)

app.include_router(suppliers.router, prefix="/api/v1/suppliers", tags=["Suppliers"])
app.include_router(invoices.router, prefix="/api/v1/invoices", tags=["Invoices"])
app.include_router(disbursement_plans.router, prefix="/api/v1/plans", tags=["Disbursement Plans"])
app.include_router(disbursements.router, prefix="/api/v1/disbursements", tags=["Disbursements"])


# 4. Gáº¯n Page Router (phá»¥c vá»¥ HTML - giá»¯ nguyÃªn)
app.include_router(pages.router, tags=["Web Pages"])
============================================================

============================================================
FILE: src\core\config.py
============================================================
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    DATABASE_URL: str

    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"

settings = Settings()

============================================================

============================================================
FILE: src\core\templating.py
============================================================
# File: src/core/templating.py

from fastapi.templating import Jinja2Templates
from pathlib import Path

# XÃ¡c Ä‘á»‹nh Ä‘Æ°á»ng dáº«n thÆ° má»¥c gá»‘c cá»§a dá»± Ã¡n
BASE_DIR = Path(__file__).resolve().parent.parent.parent

# Khá»Ÿi táº¡o Ä‘á»‘i tÆ°á»£ng templates á»Ÿ Ä‘Ã¢y
templates = Jinja2Templates(directory=BASE_DIR / "templates")
============================================================

============================================================
FILE: src\routes\disbursement_plans.py
============================================================
from fastapi import APIRouter, Depends, HTTPException
from typing import List
from sqlalchemy.ext.asyncio import AsyncSession
from src.schemas.disbursement_plan import DisbursementPlanResponse, DisbursementPlanCreate, DisbursementPlanUpdate
from src.schemas.disbursement import GenerateInterestScheduleResponse
from src.services.database import disbursement_plan as plan_db
from src.services.database.base import get_db_session
from src.services.database.disbursement import generate_interest_schedule, delete_interest_schedule

router = APIRouter()

@router.get("", response_model=List[DisbursementPlanResponse])
async def get_all_disbursement_plans(db: AsyncSession = Depends(get_db_session)):
    return await plan_db.db_get_all_disbursement_plans(db)

@router.post("", response_model=DisbursementPlanResponse, status_code=201)
async def create_new_disbursement_plan(
    plan: DisbursementPlanCreate,
    db: AsyncSession = Depends(get_db_session)
):
    """API Ä‘á»ƒ táº¡o káº¿ hoáº¡ch má»›i."""
    return await plan_db.db_create_disbursement_plan(db, plan)

@router.post("/{plan_id}/generate-interest-schedule", response_model=GenerateInterestScheduleResponse)
async def create_interest_schedule_for_plan(
    plan_id: int,
    db: AsyncSession = Depends(get_db_session)
):
    """Táº¡o lá»‹ch tráº£ lÃ£i tá»± Ä‘á»™ng cho toÃ n bá»™ Káº¿ hoáº¡ch."""
    result = await generate_interest_schedule(db=db, plan_id=plan_id)
    if not result["success"]:
        raise HTTPException(status_code=400, detail=result["message"])
    return GenerateInterestScheduleResponse(**result)

@router.delete("/{plan_id}/interest-schedule")
async def remove_interest_schedule_for_plan(
    plan_id: int,
    db: AsyncSession = Depends(get_db_session)
):
    """XÃ³a táº¥t cáº£ lá»‹ch tráº£ lÃ£i cá»§a má»™t Káº¿ hoáº¡ch."""
    result = await delete_interest_schedule(db=db, plan_id=plan_id)
    return result


@router.get("/{plan_id}", response_model=DisbursementPlanResponse)
async def read_plan_by_id(plan_id: int, db: AsyncSession = Depends(get_db_session)):
    """API Ä‘á»ƒ láº¥y thÃ´ng tin chi tiáº¿t cá»§a 1 káº¿ hoáº¡ch."""
    db_plan = await plan_db.db_get_plan_by_id(db, plan_id=plan_id)
    if db_plan is None:
        raise HTTPException(status_code=404, detail="Disbursement plan not found")
    return db_plan

@router.put("/{plan_id}", response_model=DisbursementPlanResponse)
async def update_existing_plan(
    plan_id: int,
    plan_in: DisbursementPlanUpdate,
    db: AsyncSession = Depends(get_db_session)
):
    """API Ä‘á»ƒ cáº­p nháº­t thÃ´ng tin káº¿ hoáº¡ch."""
    db_plan = await plan_db.db_get_plan_by_id(db, plan_id=plan_id)
    if db_plan is None:
        raise HTTPException(status_code=404, detail="Disbursement plan not found")
    
    return await plan_db.db_update_plan(db, db_plan=db_plan, plan_in=plan_in)

@router.delete("/{plan_id}", status_code=204)
async def delete_existing_plan(plan_id: int, db: AsyncSession = Depends(get_db_session)):
    """API Ä‘á»ƒ xÃ³a káº¿ hoáº¡ch."""
    db_plan = await plan_db.db_get_plan_by_id(db, plan_id=plan_id)
    if db_plan is None:
        raise HTTPException(status_code=404, detail="Disbursement plan not found")
    
    await plan_db.db_delete_plan(db, db_plan=db_plan)
    return None
============================================================

============================================================
FILE: src\routes\disbursements.py
============================================================
from fastapi import APIRouter, Depends, HTTPException
from typing import List
from sqlalchemy.ext.asyncio import AsyncSession
from src.schemas.disbursement import DisbursementResponse, DisbursementCreate, DisbursementUpdate
from src.services.database import disbursement as disbursement_db
from src.services.database.base import get_db_session

router = APIRouter()

@router.get("/plan/{plan_id}", response_model=List[DisbursementResponse])
async def get_disbursements_for_plan(
    plan_id: int,
    db: AsyncSession = Depends(get_db_session)
):
    return await disbursement_db.db_get_disbursements_by_plan_id(db, plan_id)

@router.post("/", response_model=DisbursementResponse, status_code=201)
async def create_new_disbursement(
    disbursement: DisbursementCreate,
    db: AsyncSession = Depends(get_db_session)
):
    return await disbursement_db.db_create_disbursement(db, disbursement)

@router.get("/{disbursement_id}", response_model=DisbursementResponse)
async def read_disbursement_by_id(disbursement_id: int, db: AsyncSession = Depends(get_db_session)):
    """API Ä‘á»ƒ láº¥y thÃ´ng tin chi tiáº¿t cá»§a 1 láº§n giáº£i ngÃ¢n."""
    db_disbursement = await disbursement_db.db_get_disbursement_by_id(db, disbursement_id=disbursement_id)
    if db_disbursement is None:
        raise HTTPException(status_code=404, detail="Disbursement not found")
    return db_disbursement

@router.put("/{disbursement_id}", response_model=DisbursementResponse)
async def update_existing_disbursement(
    disbursement_id: int,
    disbursement_in: DisbursementUpdate,
    db: AsyncSession = Depends(get_db_session)
):
    """API Ä‘á»ƒ cáº­p nháº­t thÃ´ng tin giáº£i ngÃ¢n."""
    db_disbursement = await disbursement_db.db_get_disbursement_by_id(db, disbursement_id=disbursement_id)
    if db_disbursement is None:
        raise HTTPException(status_code=404, detail="Disbursement not found")
    
    return await disbursement_db.db_update_disbursement(db, db_disbursement=db_disbursement, disbursement_in=disbursement_in)

@router.delete("/{disbursement_id}", status_code=204)
async def delete_existing_disbursement(disbursement_id: int, db: AsyncSession = Depends(get_db_session)):
    """API Ä‘á»ƒ xÃ³a má»™t láº§n giáº£i ngÃ¢n."""
    db_disbursement = await disbursement_db.db_get_disbursement_by_id(db, disbursement_id=disbursement_id)
    if db_disbursement is None:
        raise HTTPException(status_code=404, detail="Disbursement not found")
    
    await disbursement_db.db_delete_disbursement(db, db_disbursement=db_disbursement)
    return None
============================================================

============================================================
FILE: src\routes\invoices.py
============================================================
from fastapi import APIRouter, HTTPException, Depends
from typing import List
from sqlalchemy.ext.asyncio import AsyncSession
from src.schemas.invoice import InvoiceCreate, InvoiceResponse, InvoiceWithSupplierResponse, InvoiceUpdate, InvoiceDetailResponse
from src.services.database import invoice as invoice_db
from src.services.database.base import get_db_session

router = APIRouter()


@router.get("/", response_model=List[InvoiceDetailResponse])
async def read_all_invoices(db: AsyncSession = Depends(get_db_session)):
    """Láº¥y danh sÃ¡ch táº¥t cáº£ hÃ³a Ä‘Æ¡n."""
    return await invoice_db.db_get_all_invoices(db)

@router.post("/", response_model=InvoiceResponse, status_code=201)
async def create_new_invoice(
    invoice: InvoiceCreate,
    db: AsyncSession = Depends(get_db_session)
):
    try:
        return await invoice_db.db_create_invoice(db, invoice)
    except Exception as e:
        raise HTTPException(status_code=400, detail=str(e))

@router.get("/plan/{plan_id}", response_model=List[InvoiceWithSupplierResponse])
async def read_invoices_for_plan(
    plan_id: int,
    db: AsyncSession = Depends(get_db_session)
):
    return await invoice_db.db_get_all_invoices_by_plan_id(db, plan_id)

@router.get("/{invoice_id}", response_model=InvoiceDetailResponse)
async def read_invoice_by_id(invoice_id: int, db: AsyncSession = Depends(get_db_session)):
    """API Ä‘á»ƒ láº¥y thÃ´ng tin chi tiáº¿t cá»§a 1 hÃ³a Ä‘Æ¡n."""
    db_invoice = await invoice_db.db_get_invoice_by_id(db, invoice_id=invoice_id)
    if db_invoice is None:
        raise HTTPException(status_code=404, detail="Invoice not found")
    return db_invoice

@router.put("/{invoice_id}", response_model=InvoiceResponse)
async def update_existing_invoice(
    invoice_id: int,
    invoice_in: InvoiceUpdate,
    db: AsyncSession = Depends(get_db_session)
):
    """API Ä‘á»ƒ cáº­p nháº­t thÃ´ng tin hÃ³a Ä‘Æ¡n."""
    db_invoice = await invoice_db.db_get_invoice_by_id(db, invoice_id=invoice_id)
    if db_invoice is None:
        raise HTTPException(status_code=404, detail="Invoice not found")
    
    return await invoice_db.db_update_invoice(db, db_invoice=db_invoice, invoice_in=invoice_in)

@router.delete("/{invoice_id}", status_code=204)
async def delete_existing_invoice(invoice_id: int, db: AsyncSession = Depends(get_db_session)):
    """API Ä‘á»ƒ xÃ³a hÃ³a Ä‘Æ¡n."""
    db_invoice = await invoice_db.db_get_invoice_by_id(db, invoice_id=invoice_id)
    if db_invoice is None:
        raise HTTPException(status_code=404, detail="Invoice not found")
    
    await invoice_db.db_delete_invoice(db, db_invoice=db_invoice)
    return None
============================================================

============================================================
FILE: src\routes\pages.py
============================================================
# File: src/routes/pages.py (ÄÃƒ Sá»¬A Lá»–I)

from fastapi import APIRouter, Request
from fastapi.responses import HTMLResponse
# Sá»­a dÃ²ng import nÃ y: thay vÃ¬ tá»« src.core.app, hÃ£y import tá»« file má»›i
from src.core.templating import templates

router = APIRouter()

@router.get("/", response_class=HTMLResponse)
async def home_page(request: Request):
    return templates.TemplateResponse(
        "home.html",
        {
            "request": request,
            "title": "Trang chá»§ - Quáº£n lÃ½ HÃ³a Ä‘Æ¡n"
        }
    )
============================================================

============================================================
FILE: src\routes\suppliers.py
============================================================
from fastapi import APIRouter, HTTPException, Depends
from typing import List
from sqlalchemy.ext.asyncio import AsyncSession
from src.schemas.supplier import SupplierCreate, SupplierResponse, SupplierUpdate
from src.services.database import supplier as supplier_db
from src.services.database.base import get_db_session

router = APIRouter()

@router.post("/", response_model=SupplierResponse, status_code=201)
async def create_new_supplier(
    supplier: SupplierCreate,
    db: AsyncSession = Depends(get_db_session)
):
    try:
        return await supplier_db.db_create_supplier(db, supplier)
    except Exception as e:
        raise HTTPException(status_code=400, detail=str(e))

@router.get("/", response_model=List[SupplierResponse])
async def read_all_suppliers(db: AsyncSession = Depends(get_db_session)):
    return await supplier_db.db_get_all_suppliers(db)

@router.get("/{supplier_id}", response_model=SupplierResponse)
async def read_supplier_by_id(supplier_id: int, db: AsyncSession = Depends(get_db_session)):
    """API Ä‘á»ƒ láº¥y thÃ´ng tin chi tiáº¿t cá»§a 1 nhÃ  cung cáº¥p."""
    db_supplier = await supplier_db.db_get_supplier_by_id(db, supplier_id=supplier_id)
    if db_supplier is None:
        raise HTTPException(status_code=404, detail="Supplier not found")
    return db_supplier

@router.put("/{supplier_id}", response_model=SupplierResponse)
async def update_existing_supplier(
    supplier_id: int,
    supplier_in: SupplierUpdate,
    db: AsyncSession = Depends(get_db_session)
):
    """API Ä‘á»ƒ cáº­p nháº­t thÃ´ng tin nhÃ  cung cáº¥p."""
    db_supplier = await supplier_db.db_get_supplier_by_id(db, supplier_id=supplier_id)
    if db_supplier is None:
        raise HTTPException(status_code=404, detail="Supplier not found")
    
    return await supplier_db.db_update_supplier(db, db_supplier=db_supplier, supplier_in=supplier_in)

@router.delete("/{supplier_id}", status_code=204)
async def delete_existing_supplier(supplier_id: int, db: AsyncSession = Depends(get_db_session)):
    """API Ä‘á»ƒ xÃ³a nhÃ  cung cáº¥p."""
    db_supplier = await supplier_db.db_get_supplier_by_id(db, supplier_id=supplier_id)
    if db_supplier is None:
        raise HTTPException(status_code=404, detail="Supplier not found")
    
    await supplier_db.db_delete_supplier(db, db_supplier=db_supplier)
    # Status 204 No Content khÃ´ng tráº£ vá» body
    return None

# --- Káº¾T THÃšC PHáº¦N Bá»” SUNG ---
============================================================

============================================================
FILE: src\schemas\__init__.py
============================================================

============================================================

============================================================
FILE: src\schemas\disbursement.py
============================================================
# File: src/schemas/disbursement.py

from pydantic import BaseModel, Field
from typing import Optional
from datetime import date, datetime # <-- ThÃªm 'datetime' vÃ o Ä‘Ã¢y
from decimal import Decimal


class DisbursementBase(BaseModel):
    plan_id: int
    planned_date: Optional[date] = None
    planned_amount: Optional[Decimal] = None
    actual_date: Optional[date] = None
    actual_amount: Optional[Decimal] = None
    bank_name: Optional[str] = None
    loan_contract_number: Optional[str] = None
    loan_term_months: Optional[int] = None
    loan_interest_rate: Optional[float] = None
    interest_amount: Optional[Decimal] = None
    interest_due_date: Optional[date] = None
    principal_due_date: Optional[date] = None
    parent_disbursement_id: Optional[int] = None


class DisbursementCreate(DisbursementBase):
    pass


class DisbursementUpdate(BaseModel):
    planned_date: Optional[date] = None
    planned_amount: Optional[Decimal] = None
    actual_date: Optional[date] = None
    actual_amount: Optional[Decimal] = None
    bank_name: Optional[str] = None
    loan_contract_number: Optional[str] = None
    loan_term_months: Optional[int] = None
    loan_interest_rate: Optional[float] = None
    interest_amount: Optional[Decimal] = None
    interest_due_date: Optional[date] = None
    principal_due_date: Optional[date] = None
    parent_disbursement_id: Optional[int] = None


class DisbursementResponse(DisbursementBase):
    id: int
    # Sá»¬A DÃ’NG NÃ€Y: Chuyá»ƒn tá»« 'date' sang 'datetime'
    created_at: datetime 

    class Config:
        from_attributes = True


class GenerateInterestScheduleRequest(BaseModel):
    """Request Ä‘á»ƒ táº¡o lá»‹ch tráº£ lÃ£i"""
    disbursement_id: int
    periodic_interest_day: Optional[int] = Field(None, ge=1, le=31, description="NgÃ y tráº£ lÃ£i hÃ ng thÃ¡ng (1-31). Náº¿u null thÃ¬ láº¥y tá»« plan")


class GenerateInterestScheduleResponse(BaseModel):
    """Response sau khi táº¡o lá»‹ch tráº£ lÃ£i"""
    success: bool
    message: str
    schedules_created: int
    schedule_dates: list[date]
============================================================

============================================================
FILE: src\schemas\disbursement_plan.py
============================================================
from pydantic import BaseModel, Field
from typing import Optional
from datetime import datetime, date # ThÃªm 'date' vÃ o Ä‘Ã¢y

class DisbursementPlanBase(BaseModel):
    name: str
    description: Optional[str] = None
    periodic_interest_day: int = Field(default=25, ge=1, le=31)
    actual_date: Optional[date] = None
    principal_due_date: Optional[date] = None
    bank_name: Optional[str] = None
    loan_contract_number: Optional[str] = None


class DisbursementPlanCreate(DisbursementPlanBase):
    pass

class DisbursementPlanUpdate(BaseModel):
    name: Optional[str] = None
    description: Optional[str] = None
    periodic_interest_day: Optional[int] = Field(None, ge=1, le=31)
    actual_date: Optional[date] = None
    principal_due_date: Optional[date] = None
    bank_name: Optional[str] = None
    loan_contract_number: Optional[str] = None

class DisbursementPlanResponse(DisbursementPlanBase):
    id: int
    created_at: datetime  

    class Config:
        from_attributes = True
============================================================

============================================================
FILE: src\schemas\invoice.py
============================================================
from pydantic import BaseModel, ConfigDict
from datetime import date
from typing import Optional

# Lá»›p cÆ¡ sá»Ÿ chá»©a cÃ¡c trÆ°á»ng chung cá»§a má»™t hÃ³a Ä‘Æ¡n
class InvoiceBase(BaseModel):
    plan_id: int
    supplier_id: int
    invoice_number: str
    issue_date: date
    total_value: float

# Schema dÃ¹ng Ä‘á»ƒ Táº O Má»šI má»™t hÃ³a Ä‘Æ¡n (dá»¯ liá»‡u Ä‘áº§u vÃ o)
class InvoiceCreate(InvoiceBase):
    pass # Káº¿ thá»«a táº¥t cáº£ cÃ¡c trÆ°á»ng tá»« InvoiceBase





# Schema dÃ¹ng Ä‘á»ƒ TRáº¢ Vá»€ sau khi táº¡o má»›i hoáº·c láº¥y má»™t hÃ³a Ä‘Æ¡n
class InvoiceResponse(InvoiceBase):
    id: int
    status: str

    # Cáº¥u hÃ¬nh Ä‘á»ƒ Pydantic cÃ³ thá»ƒ Ä‘á»c dá»¯ liá»‡u tá»« object SQLAlchemy
    model_config = ConfigDict(from_attributes=True)


class SupplierResponse(BaseModel):
    model_config = ConfigDict(from_attributes=True)
    
    id: int
    name: str

class InvoiceWithSupplierResponse(BaseModel):
    model_config = ConfigDict(from_attributes=True)
    
    id: int
    invoice_number: str
    issue_date: date
    total_value: float
    supplier_id: int
    status: str
    # Má»‘i quan há»‡ nÃ y cho phÃ©p tráº£ vá» thÃ´ng tin cá»§a nhÃ  cung cáº¥p kÃ¨m theo hÃ³a Ä‘Æ¡n
    supplier: Optional[SupplierResponse] = None

class InvoiceUpdate(BaseModel):
    plan_id: int | None = None         # Bá»• sung cho phÃ©p sá»­a plan_id náº¿u cáº§n
    supplier_id: int | None = None
    invoice_number: str | None = None
    issue_date: date | None = None
    total_value: float | None = None
    status: str | None = None


# Schema rÃºt gá»n cho Supplier khi hiá»ƒn thá»‹ trong Invoice
class SupplierRef(BaseModel):
    id: int
    name: str
    model_config = ConfigDict(from_attributes=True)

# Schema rÃºt gá»n cho Plan khi hiá»ƒn thá»‹ trong Invoice
class PlanRef(BaseModel):
    id: int
    name: str
    model_config = ConfigDict(from_attributes=True)

# Schema Invoice Ä‘áº§y Ä‘á»§ thÃ´ng tin cho trang danh sÃ¡ch
class InvoiceDetailResponse(InvoiceResponse):
    supplier: Optional[SupplierRef] = None
    plan: Optional[PlanRef] = None
============================================================

============================================================
FILE: src\schemas\supplier.py
============================================================
from pydantic import BaseModel

class SupplierBase(BaseModel):
    name: str
    contact_info: str | None = None

class SupplierCreate(SupplierBase):
    pass

class SupplierUpdate(BaseModel):
    name: str | None = None
    contact_info: str | None = None

class SupplierResponse(SupplierBase):
    id: int

    class Config:
        from_attributes = True
============================================================

============================================================
FILE: src\services\database\base.py
============================================================
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession, async_sessionmaker
from sqlalchemy.orm import declarative_base
from src.core.config import settings
import logging

logger = logging.getLogger(__name__)

# Base class cho ORM models
Base = declarative_base()

# --- Báº®T Äáº¦U PHáº¦N Sá»¬A Lá»–I ---

# 1. Láº¥y URL tá»« file config ra má»™t biáº¿n táº¡m
#db_url = settings.DATABASE_URL

db_url = "postgresql://postgres.sxhpsfboyzsuvjcvvqty:atino2025@aws-1-ap-southeast-1.pooler.supabase.com:5432/postgres"

# 2. Kiá»ƒm tra xem biáº¿n DATABASE_URL cÃ³ Ä‘Æ°á»£c thiáº¿t láº­p hay khÃ´ng
if not db_url:
    raise ValueError("Lá»—i: Biáº¿n DATABASE_URL chÆ°a Ä‘Æ°á»£c thiáº¿t láº­p trong file .env")

# 3. Kiá»ƒm tra vÃ  tá»± Ä‘á»™ng sá»­a chuá»—i káº¿t ná»‘i Ä‘á»ƒ sá»­ dá»¥ng driver asyncpg
if db_url.startswith("postgresql://"):
    db_url = db_url.replace("postgresql://", "postgresql+asyncpg://", 1)
    logger.info("Chuá»—i káº¿t ná»‘i Ä‘Ã£ Ä‘Æ°á»£c tá»± Ä‘á»™ng cáº¥u hÃ¬nh Ä‘á»ƒ sá»­ dá»¥ng driver asyncpg.")



# Táº¡o async engine vá»›i chuá»—i káº¿t ná»‘i Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½
engine = create_async_engine(
    db_url,  # <-- Sá»­ dá»¥ng biáº¿n db_url Ä‘Ã£ Ä‘Æ°á»£c sá»­a
    pool_size=5,
    max_overflow=10,
    pool_timeout=30,
    pool_recycle=1800,
    pool_pre_ping=True,
    echo=False,
    future=True
)

# Session factory (Pháº§n nÃ y giá»¯ nguyÃªn)
AsyncSessionFactory = async_sessionmaker(
    engine,
    class_=AsyncSession,
    expire_on_commit=False
)

async def get_db_session():
    """Dependency Ä‘á»ƒ inject database session vÃ o routes"""
    async with AsyncSessionFactory() as session:
        try:
            yield session
            await session.commit()
        except Exception:
            await session.rollback()
            raise
        finally:
            await session.close()
============================================================

============================================================
FILE: src\services\database\disbursement.py
============================================================
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.future import select
from .schema import Disbursement, DisbursementPlan  # Import cáº£ hai
from src.schemas.disbursement import DisbursementCreate, DisbursementUpdate
from src.utils.interest_calculator import generate_interest_payment_dates
from datetime import date
from typing import List, Optional

# ==============================================================================
# HÃ€M Táº O Lá»ŠCH TRáº¢ LÃƒI Tá»° Äá»˜NG (ÄÃƒ VIáº¾T Láº I THEO LOGIC Má»šI)
# ==============================================================================

async def generate_interest_schedule(
    db: AsyncSession,
    plan_id: int  # <-- THAY Äá»”I: DÃ¹ng plan_id
) -> dict:
    """
    Táº¡o lá»‹ch tráº£ lÃ£i tá»± Ä‘á»™ng cho má»™t Káº¿ Hoáº¡ch Giáº£i NgÃ¢n
    
    Args:
        db: Database session
        plan_id: ID cá»§a Káº¿ Hoáº¡ch (DisbursementPlan)
    
    Returns:
        dict vá»›i thÃ´ng tin káº¿t quáº£
    """
    
    # 1. Láº¥y thÃ´ng tin Káº¿ Hoáº¡ch (Plan)
    result = await db.execute(
        select(DisbursementPlan).where(DisbursementPlan.id == plan_id)
    )
    plan = result.scalar_one_or_none()
    
    if not plan:
        return {
            "success": False,
            "message": f"KhÃ´ng tÃ¬m tháº¥y Káº¿ hoáº¡ch (plan) vá»›i id={plan_id}",
            "schedules_created": 0,
            "schedule_dates": []
        }
    
    # 2. Kiá»ƒm tra cÃ¡c trÆ°á»ng báº¯t buá»™c TRÃŠN PLAN
    if not plan.actual_date or not plan.principal_due_date:
        return {
            "success": False,
            "message": "Káº¿ hoáº¡ch nÃ y pháº£i cÃ³ 'NgÃ y thá»±c táº¿ vay' vÃ  'NgÃ y Ä‘Ã¡o háº¡n (tráº£ gá»‘c)'",
            "schedules_created": 0,
            "schedule_dates": []
        }
    
    # 3. Láº¥y ngÃ y tráº£ lÃ£i Ä‘á»‹nh ká»³ tá»« plan
    periodic_interest_day = plan.periodic_interest_day
    
    # 4. XÃ³a cÃ¡c dÃ²ng tráº£ lÃ£i cÅ© (náº¿u cÃ³) Ä‘á»ƒ táº¡o láº¡i
    old_schedules_result = await db.execute(
        select(Disbursement).where(Disbursement.plan_id == plan_id)
    )
    old_schedules = old_schedules_result.scalars().all()
    
    count_deleted = 0
    for old_schedule in old_schedules:
        await db.delete(old_schedule)
        count_deleted += 1
    
    # 5. TÃ­nh toÃ¡n cÃ¡c ngÃ y tráº£ lÃ£i
    payment_dates = generate_interest_payment_dates(
        actual_date=plan.actual_date,
        principal_due_date=plan.principal_due_date,
        periodic_day=periodic_interest_day
    )
    
    if not payment_dates:
        return {
            "success": False,
            "message": "KhÃ´ng thá»ƒ táº¡o lá»‹ch tráº£ lÃ£i (ngÃ y vay >= ngÃ y tráº£ ná»£ gá»‘c)",
            "schedules_created": 0,
            "schedule_dates": []
        }
    
    # 6. Táº¡o cÃ¡c dÃ²ng disbursement (lá»‹ch lÃ£i)
    # Giáº£ Ä‘á»‹nh schema.py Ä‘Ã£ Ä‘Æ°á»£c sá»­a, báº£ng Disbursement giá» Ráº¤T Ä‘Æ¡n giáº£n
    created_schedules = []
    for payment_date in payment_dates:
        new_schedule = Disbursement(
            plan_id=plan.id,
            interest_due_date=payment_date, # DÃ¹ng cá»™t má»›i `interest_due_date`
            interest_amount=None,           # Tiá»n lÃ£i sáº½ Ä‘Æ°á»£c cáº­p nháº­t sau
            actual_date=None                # NgÃ y thá»±c tráº£ sáº½ Ä‘Æ°á»£c cáº­p nháº­t sau
        )
        db.add(new_schedule)
        created_schedules.append(new_schedule)
    
    await db.commit() # Commit Ä‘á»ƒ lÆ°u cÃ¡c thay Ä‘á»•i
    
    return {
        "success": True,
        "message": f"ÄÃ£ xÃ³a {count_deleted} lá»‹ch cÅ©. ÄÃ£ táº¡o {len(payment_dates)} ká»³ tráº£ lÃ£i má»›i thÃ nh cÃ´ng.",
        "schedules_created": len(payment_dates),
        "schedule_dates": payment_dates
    }

# ==============================================================================
# HÃ€M XÃ“A Lá»ŠCH (CÅ¨NG ÄÆ¯á»¢C VIáº¾T Láº I THEO LOGIC Má»šI)
# ==============================================================================

async def delete_interest_schedule(db: AsyncSession, plan_id: int) -> dict: # <-- THAY Äá»”I
    """
    XÃ³a táº¥t cáº£ lá»‹ch tráº£ lÃ£i cá»§a má»™t Káº¿ Hoáº¡ch
    
    Args:
        db: Database session
        plan_id: ID cá»§a Káº¿ Hoáº¡ch (DisbursementPlan)
    
    Returns:
        dict vá»›i thÃ´ng tin káº¿t quáº£
    """
    result = await db.execute(
        select(Disbursement).where(Disbursement.plan_id == plan_id) # <-- THAY Äá»”I
    )
    schedules = result.scalars().all()
    
    count = len(schedules)
    for schedule in schedules:
        await db.delete(schedule)
    
    await db.commit()
    
    return {
        "success": True,
        "message": f"ÄÃ£ xÃ³a {count} ká»³ tráº£ lÃ£i",
        "schedules_deleted": count
    }


# ==============================================================================
# CÃC HÃ€M CRUD CÆ  Báº¢N (ÄÃƒ Cáº¬P NHáº¬T THEO LOGIC Má»šI)
# ==============================================================================

async def db_create_disbursement(db: AsyncSession, disbursement: DisbursementCreate):
    """
    Táº¡o má»™t dÃ²ng lá»‹ch sá»­ tráº£ lÃ£i (thÆ°á»ng lÃ  thá»§ cÃ´ng, khÃ´ng dÃ¹ng hÃ m tá»± Ä‘á»™ng)
    LÆ¯U Ã: schema `DisbursementCreate` cáº§n Ä‘Æ°á»£c cáº­p nháº­t
    """
    # HÃ m nÃ y giá» sáº½ nháº­n schema create má»›i
    # (schema.py cho DisbursementCreate cÅ©ng cáº§n Ä‘Æ°á»£c sá»­a)
    new_disbursement = Disbursement(**disbursement.model_dump())
    db.add(new_disbursement)
    await db.flush()
    await db.refresh(new_disbursement)
    return new_disbursement

async def db_get_disbursements_by_plan_id(db: AsyncSession, plan_id: int):
    """Láº¥y táº¥t cáº£ cÃ¡c ká»³ tráº£ lÃ£i cá»§a má»™t káº¿ hoáº¡ch."""
    result = await db.execute(
        select(Disbursement)
        .where(Disbursement.plan_id == plan_id)
        .order_by(Disbursement.interest_due_date) # Sáº¯p xáº¿p theo ngÃ y tráº£ lÃ£i
    )
    return result.scalars().all()

async def db_get_disbursement_by_id(db: AsyncSession, disbursement_id: int) -> Disbursement | None:
    """Láº¥y má»™t ká»³ tráº£ lÃ£i theo ID."""
    result = await db.execute(select(Disbursement).where(Disbursement.id == disbursement_id))
    return result.scalars().first()

async def db_update_disbursement(db: AsyncSession, db_disbursement: Disbursement, disbursement_in: DisbursementUpdate) -> Disbursement:
    """
    Cáº­p nháº­t thÃ´ng tin má»™t ká»³ tráº£ lÃ£i (vÃ­ dá»¥: cáº­p nháº­t sá»‘ tiá»n Ä‘Ã£ tráº£)
    LÆ¯U Ã: schema `DisbursementUpdate` cáº§n Ä‘Æ°á»£c cáº­p nháº­t
    """
    update_data = disbursement_in.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(db_disbursement, key, value)
    
    await db.flush()
    await db.refresh(db_disbursement)
    return db_disbursement

async def db_delete_disbursement(db: AsyncSession, db_disbursement: Disbursement):
    """XÃ³a má»™t ká»³ tráº£ lÃ£i cá»¥ thá»ƒ."""
    await db.delete(db_disbursement)
    await db.flush()
============================================================

============================================================
FILE: src\services\database\disbursement_plan.py
============================================================
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.future import select
from .schema import DisbursementPlan
from src.schemas.disbursement_plan import DisbursementPlanCreate, DisbursementPlanUpdate

async def db_get_all_disbursement_plans(db: AsyncSession):
    result = await db.execute(
        select(DisbursementPlan).order_by(DisbursementPlan.name)
    )
    return result.scalars().all()

async def db_create_disbursement_plan(db: AsyncSession, plan: DisbursementPlanCreate) -> DisbursementPlan:
    """Táº¡o má»™t káº¿ hoáº¡ch giáº£i ngÃ¢n má»›i."""
    new_plan = DisbursementPlan(**plan.model_dump())
    db.add(new_plan)
    await db.flush()
    await db.refresh(new_plan)
    return new_plan

async def db_get_plan_by_id(db: AsyncSession, plan_id: int) -> DisbursementPlan | None:
    """Láº¥y má»™t káº¿ hoáº¡ch theo ID."""
    result = await db.execute(select(DisbursementPlan).where(DisbursementPlan.id == plan_id))
    return result.scalars().first()

async def db_update_plan(db: AsyncSession, db_plan: DisbursementPlan, plan_in: DisbursementPlanUpdate) -> DisbursementPlan:
    """Cáº­p nháº­t thÃ´ng tin káº¿ hoáº¡ch."""
    update_data = plan_in.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(db_plan, key, value)
    
    await db.flush()
    await db.refresh(db_plan)
    return db_plan

async def db_delete_plan(db: AsyncSession, db_plan: DisbursementPlan):
    """XÃ³a má»™t káº¿ hoáº¡ch."""
    await db.delete(db_plan)
    await db.flush()
============================================================

============================================================
FILE: src\services\database\invoice.py
============================================================
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.future import select
from sqlalchemy.orm import selectinload
from .schema import Invoice, Supplier
from src.schemas.invoice import InvoiceCreate, InvoiceUpdate



async def db_get_all_invoices(db: AsyncSession):
    """Láº¥y táº¥t cáº£ hÃ³a Ä‘Æ¡n kÃ¨m thÃ´ng tin NCC vÃ  Káº¿ hoáº¡ch."""
    result = await db.execute(
        select(Invoice)
        .options(
            selectinload(Invoice.supplier),
            selectinload(Invoice.plan)
        )
        .order_by(Invoice.issue_date.desc())
    )
    return result.scalars().all()


async def db_create_invoice(db: AsyncSession, invoice: InvoiceCreate):
    new_invoice = Invoice(**invoice.model_dump())
    db.add(new_invoice)
    await db.flush()
    await db.refresh(new_invoice)
    return new_invoice

async def db_get_all_invoices_by_plan_id(db: AsyncSession, plan_id: int):
    result = await db.execute(
        select(Invoice)
        .options(selectinload(Invoice.supplier))
        .where(Invoice.plan_id == plan_id)
        .order_by(Invoice.issue_date.desc())
    )
    return result.scalars().all()

async def db_get_invoice_by_id(db: AsyncSession, invoice_id: int) -> Invoice | None:
    result = await db.execute(
        select(Invoice)
        .options(
            selectinload(Invoice.supplier),
            selectinload(Invoice.plan)
        )
        .where(Invoice.id == invoice_id)
    )
    return result.scalars().first()

async def db_update_invoice(db: AsyncSession, db_invoice: Invoice, invoice_in: InvoiceUpdate) -> Invoice:
    """Cáº­p nháº­t thÃ´ng tin hÃ³a Ä‘Æ¡n."""
    update_data = invoice_in.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(db_invoice, key, value)
    
    await db.flush()
    await db.refresh(db_invoice)
    return db_invoice

async def db_delete_invoice(db: AsyncSession, db_invoice: Invoice):
    """XÃ³a má»™t hÃ³a Ä‘Æ¡n."""
    await db.delete(db_invoice)
    await db.flush()
============================================================

============================================================
FILE: src\services\database\schema.py
============================================================
from sqlalchemy import Column, BigInteger, Text, Date, Numeric, Integer, Float, ForeignKey
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from datetime import datetime
from .base import Base


class Supplier(Base):
    __tablename__ = "suppliers"
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    name = Column(Text, nullable=False)
    contact_info = Column(Text)
    created_at = Column(Date, server_default=func.now())
    
    # Relationship
    invoices = relationship("Invoice", back_populates="supplier")


class DisbursementPlan(Base):
    __tablename__ = "disbursement_plans"
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    name = Column(Text, nullable=False)
    description = Column(Text)
    periodic_interest_day = Column(Integer, default=25)  # â† THÃŠM DÃ’NG NÃ€Y
    created_at = Column(Date, server_default=func.now())
    actual_date = Column(Date)              # NgÃ y thá»±c táº¿ vay
    principal_due_date = Column(Date)       # NgÃ y Ä‘Ã¡o háº¡n
    bank_name = Column(Text)                # (NÃªn thÃªm cáº£ thÃ´ng tin ngÃ¢n hÃ ng á»Ÿ Ä‘Ã¢y)
    loan_contract_number = Column(Text)     # (VÃ  sá»‘ há»£p Ä‘á»“ng)

    # Relationships
    invoices = relationship("Invoice", back_populates="plan", cascade="all, delete-orphan")
    disbursements = relationship("Disbursement", back_populates="plan", cascade="all, delete-orphan")


class Invoice(Base):
    __tablename__ = "invoices"
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    plan_id = Column(BigInteger, ForeignKey("disbursement_plans.id", ondelete="CASCADE"))
    supplier_id = Column(BigInteger, ForeignKey("suppliers.id", ondelete="SET NULL"))
    invoice_number = Column(Text, nullable=False)
    issue_date = Column(Date, nullable=False)
    total_value = Column(Numeric(15, 2), nullable=False)
    status = Column(Text, default="ChÆ°a thanh toÃ¡n")
    created_at = Column(Date, server_default=func.now())
    
    # Relationships
    plan = relationship("DisbursementPlan", back_populates="invoices")
    supplier = relationship("Supplier", back_populates="invoices")


class Disbursement(Base):
    __tablename__ = "disbursements"
    
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    plan_id = Column(BigInteger, ForeignKey("disbursement_plans.id", ondelete="CASCADE"))
    
    interest_due_date = Column(Date)  # NgÃ y pháº£i tráº£ lÃ£i (quan trá»ng nháº¥t)
    interest_amount = Column(Numeric(15, 2)) # Sá»‘ tiá»n lÃ£i (tÃ­nh sau)
    actual_date = Column(Date) # CÃ³ thá»ƒ dÃ¹ng cá»™t nÃ y Ä‘á»ƒ lÆ°u NGÃ€Y THá»°C Táº¾ ÄÃƒ TRáº¢
    
    created_at = Column(Date, server_default=func.now())
    
    # Relationships
    plan = relationship("DisbursementPlan", back_populates="disbursements")
============================================================

============================================================
FILE: src\services\database\supplier.py
============================================================
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.future import select
from .schema import Supplier
from src.schemas.supplier import SupplierCreate, SupplierUpdate

async def db_create_supplier(db: AsyncSession, supplier: SupplierCreate):
    new_supplier = Supplier(**supplier.model_dump())
    db.add(new_supplier)
    await db.flush()
    await db.refresh(new_supplier)
    return new_supplier

async def db_get_all_suppliers(db: AsyncSession):
    result = await db.execute(select(Supplier).order_by(Supplier.id))
    return result.scalars().all()

async def db_get_supplier_by_id(db: AsyncSession, supplier_id: int) -> Supplier | None:
    """Láº¥y má»™t nhÃ  cung cáº¥p theo ID."""
    result = await db.execute(select(Supplier).where(Supplier.id == supplier_id))
    return result.scalars().first()

async def db_update_supplier(db: AsyncSession, db_supplier: Supplier, supplier_in: SupplierUpdate) -> Supplier:
    """Cáº­p nháº­t thÃ´ng tin nhÃ  cung cáº¥p."""
    update_data = supplier_in.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(db_supplier, key, value)
    
    await db.flush()
    await db.refresh(db_supplier)
    return db_supplier

async def db_delete_supplier(db: AsyncSession, db_supplier: Supplier):
    """XÃ³a má»™t nhÃ  cung cáº¥p."""
    await db.delete(db_supplier)
    await db.flush()
============================================================

============================================================
FILE: src\utils\interest_calculator.py
============================================================
"""
Helper functions Ä‘á»ƒ tÃ­nh toÃ¡n lá»‹ch tráº£ lÃ£i
"""
from datetime import date, timedelta
from typing import List


def get_next_business_day(target_date: date) -> date:
    """
    Náº¿u ngÃ y rÆ¡i vÃ o thá»© 7 (5) hoáº·c Chá»§ nháº­t (6), chuyá»ƒn sang thá»© 2
    
    Args:
        target_date: NgÃ y cáº§n kiá»ƒm tra
    
    Returns:
        NgÃ y thá»© 2 káº¿ tiáº¿p náº¿u lÃ  cuá»‘i tuáº§n, nguyÃªn ngÃ y náº¿u khÃ´ng
    """
    # weekday(): 0=Monday, 1=Tuesday, ..., 5=Saturday, 6=Sunday
    while target_date.weekday() >= 5:  # 5=Saturday, 6=Sunday
        target_date += timedelta(days=1)
    return target_date


def generate_interest_payment_dates(
    actual_date: date,
    principal_due_date: date,
    periodic_day: int = 25
) -> List[date]:
    """
    Sinh ra cÃ¡c ngÃ y tráº£ lÃ£i hÃ ng thÃ¡ng
    
    Logic:
    1. Náº¿u ngÃ y giáº£i ngÃ¢n >= 15 â†’ bá» qua thÃ¡ng Ä‘Ã³, báº¯t Ä‘áº§u tá»« thÃ¡ng sau
    2. Má»—i thÃ¡ng tráº£ vÃ o ngÃ y `periodic_day` (máº·c Ä‘á»‹nh 25)
    3. Náº¿u rÆ¡i thá»© 7/CN â†’ chuyá»ƒn sang thá»© 2
    4. ThÃ¡ng cuá»‘i: dÃ¹ng `principal_due_date` thay vÃ¬ ngÃ y periodic_day
    
    Args:
        actual_date: NgÃ y thá»±c táº¿ giáº£i ngÃ¢n
        principal_due_date: NgÃ y Ä‘áº¿n háº¡n tráº£ ná»£ gá»‘c
        periodic_day: NgÃ y tráº£ lÃ£i hÃ ng thÃ¡ng (1-31)
    
    Returns:
        List cÃ¡c ngÃ y tráº£ lÃ£i Ä‘Ã£ Ä‘iá»u chá»‰nh
    """
    if actual_date >= principal_due_date:
        return []
    
    payment_dates = []
    current_month_start = actual_date.replace(day=1)
    
    # Rule 1: Náº¿u ngÃ y giáº£i ngÃ¢n >= 15 â†’ báº¯t Ä‘áº§u tá»« thÃ¡ng sau
    if actual_date.day >= 15:
        # Sang thÃ¡ng sau
        if current_month_start.month == 12:
            current_month_start = current_month_start.replace(year=current_month_start.year + 1, month=1)
        else:
            current_month_start = current_month_start.replace(month=current_month_start.month + 1)
    
    # Táº¡o lá»‹ch tráº£ lÃ£i tá»«ng thÃ¡ng
    while True:
        # Táº¡o ngÃ y tráº£ lÃ£i cho thÃ¡ng hiá»‡n táº¡i
        try:
            payment_date = current_month_start.replace(day=periodic_day)
        except ValueError:
            # ThÃ¡ng khÃ´ng cÃ³ ngÃ y periodic_day (VD: thÃ¡ng 2 cÃ³ 28/29 ngÃ y mÃ  periodic_day=30)
            # â†’ Láº¥y ngÃ y cuá»‘i thÃ¡ng
            if current_month_start.month == 12:
                next_month = current_month_start.replace(year=current_month_start.year + 1, month=1)
            else:
                next_month = current_month_start.replace(month=current_month_start.month + 1)
            payment_date = next_month - timedelta(days=1)
        
        # Rule 4: ThÃ¡ng cuá»‘i â†’ dÃ¹ng principal_due_date
        if payment_date.year == principal_due_date.year and payment_date.month == principal_due_date.month:
            payment_date = principal_due_date
            payment_dates.append(payment_date)
            break
        
        # Náº¿u vÆ°á»£t quÃ¡ ngÃ y tráº£ ná»£ gá»‘c â†’ dá»«ng
        if payment_date > principal_due_date:
            break
        
        # Rule 3: Äiá»u chá»‰nh náº¿u rÆ¡i thá»© 7/CN (trá»« thÃ¡ng cuá»‘i)
        payment_date = get_next_business_day(payment_date)
        payment_dates.append(payment_date)
        
        # Sang thÃ¡ng tiáº¿p theo
        if current_month_start.month == 12:
            current_month_start = current_month_start.replace(year=current_month_start.year + 1, month=1)
        else:
            current_month_start = current_month_start.replace(month=current_month_start.month + 1)
    
    return payment_dates
============================================================

============================================================
FILE: static\css\style.css
============================================================
/* FILE: static/css/style.css (THAY THáº¾ TOÃ€N Bá»˜) */

/* --- BIáº¾N MÃ€U VÃ€ FONT CHá»® --- */
:root {
    --primary-color: #1976d2; /* Blue */
    --primary-color-dark: #004ba0;
    --accent-color: #ff4081; /* Pink */
    --background-color: #f5f5f5;
    --surface-color: #ffffff;
    --text-color-primary: #212121;
    --text-color-secondary: #757575;
    --divider-color: #e0e0e0;
    --box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 2px 10px rgba(0,0,0,0.08);
}

/* --- THIáº¾T Láº¬P CÆ  Báº¢N --- */
* {
    box-sizing: border-box;
}

body {
    font-family: 'Roboto', sans-serif;
    background-color: var(--background-color);
    color: var(--text-color-primary);
    margin: 0;
    line-height: 1.6;
}

/* --- LAYOUT CHÃNH --- */
.app-bar {
    background-color: var(--primary-color);
    color: white;
    padding: 16px 24px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    font-size: 1.25rem;
    font-weight: 500;
}

.main-container {
    padding: 24px;
    max-width: 1400px;
    margin: 0 auto;
}

.management-view {
    display: none; /* Máº·c Ä‘á»‹nh áº©n cÃ¡c view */
}

.management-view.active {
    display: block; /* Hiá»‡n view Ä‘Æ°á»£c chá»n */
}

/* --- CARD (KHUNG CHá»¨A Ná»˜I DUNG) --- */
.card {
    background: var(--surface-color);
    border-radius: 8px;
    box-shadow: var(--box-shadow);
    padding: 24px;
    margin-top: 16px;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 16px;
    margin-bottom: 16px;
    border-bottom: 1px solid var(--divider-color);
}

.card-header h2 {
    margin: 0;
    font-size: 1.5rem;
    color: var(--primary-color);
}

/* --- BUTTON --- */
.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    text-transform: uppercase;
    transition: background-color 0.2s, box-shadow 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
}
.btn-primary:hover {
    background-color: var(--primary-color-dark);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.icon-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 6px;
    border-radius: 50%;
    color: var(--text-color-secondary);
}
.icon-btn:hover {
    background-color: rgba(0, 0, 0, 0.08);
}
.icon-btn .material-icons {
    font-size: 20px;
    vertical-align: middle;
}

/* --- Báº¢NG Dá»® LIá»†U --- */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

th, td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--divider-color);
    text-align: left;
}

th {
    font-weight: 500;
    color: var(--text-color-secondary);
    font-size: 0.85rem;
    text-transform: uppercase;
}

tr:last-child td {
    border-bottom: none;
}

tr:hover {
    background-color: #f9f9f9;
}

td.actions {
    text-align: right;
    white-space: nowrap;
}

/* --- MODAL (FORM POP-UP) --- */
.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}

.modal-backdrop.visible {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background: var(--surface-color);
    padding: 24px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    width: 90%;
    max-width: 500px;
    transform: translateY(-50px);
    transition: transform 0.3s;
}

.modal-backdrop.visible .modal-content {
    transform: translateY(0);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
}

.modal-body {
    margin-bottom: 24px;
}

/* --- FORM INPUT --- */
.form-group {
    margin-bottom: 16px;
}
.form-group label {
    display: block;
    margin-bottom: 8px;
    font-size: 0.9rem;
    color: var(--text-color-secondary);
}
.form-group input, .form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--divider-color);
    border-radius: 4px;
    font-size: 1rem;
    font-family: 'Roboto', sans-serif;
}
.form-group input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
}

.hidden {
    display: none !important;
}

/* Header vÃ  Navbar */
.app-bar {
    background-color: var(--primary-color);
    color: white;
    padding: 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.app-bar-title {
    font-size: 1.25rem;
    font-weight: 700;
    padding: 16px 24px;
}

.navbar {
    display: flex;
    gap: 8px;
    padding: 0 24px;
}

.nav-btn {
    background: transparent;
    color: white;
    border: none;
    padding: 16px 20px;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 500;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 3px solid transparent;
}

.nav-btn:hover {
    background-color: rgba(255,255,255,0.1);
}

.nav-btn.active {
    background-color: rgba(255,255,255,0.15);
    border-bottom: 3px solid white;
}

.nav-btn .material-icons {
    font-size: 20px;
}

============================================================

============================================================
FILE: static\js\api.js
============================================================
async function fetchAPI(endpoint, options = {}) {
    const headers = { 'Content-Type': 'application/json', ...options.headers };
    const response = await fetch(`/api/v1/${endpoint}`, { ...options, headers });
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || 'CÃ³ lá»—i xáº£y ra');
    }
    if (response.status === 204) return null;
    return response.json();
}

export const planAPI = {
    getAll: () => fetchAPI('plans/'),
    getById: (id) => fetchAPI(`plans/${id}`),
    create: (data) => fetchAPI('plans/', { method: 'POST', body: JSON.stringify(data) }),
    update: (id, data) => fetchAPI(`plans/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
    delete: (id) => fetchAPI(`plans/${id}`, { method: 'DELETE' }),
    generateSchedule: (planId) => fetchAPI(`plans/${planId}/generate-interest-schedule`, { method: 'POST' }),
    deleteSchedule: (planId) => fetchAPI(`plans/${planId}/interest-schedule`, { method: 'DELETE' }),
};

export const supplierAPI = {
    getAll: () => fetchAPI('suppliers/'),
    getById: (id) => fetchAPI(`suppliers/${id}`),
    create: (data) => fetchAPI('suppliers/', { method: 'POST', body: JSON.stringify(data) }),
    update: (id, data) => fetchAPI(`suppliers/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
    delete: (id) => fetchAPI(`suppliers/${id}`, { method: 'DELETE' }),
};

export const invoiceAPI = {
    getByPlanId: (planId) => fetchAPI(`invoices/plan/${planId}`),
    getById: (id) => fetchAPI(`invoices/${id}`),
    create: (data) => fetchAPI('invoices/', { method: 'POST', body: JSON.stringify(data) }),
    update: (id, data) => fetchAPI(`invoices/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
    delete: (id) => fetchAPI(`invoices/${id}`, { method: 'DELETE' }),
};

export const disbursementAPI = {
    getByPlanId: (planId) => fetchAPI(`disbursements/plan/${planId}`),
    getById: (id) => fetchAPI(`disbursements/${id}`),
    create: (data) => fetchAPI('disbursements/', { method: 'POST', body: JSON.stringify(data) }),
    update: (id, data) => fetchAPI(`disbursements/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
    delete: (id) => fetchAPI(`disbursements/${id}`, { method: 'DELETE' }),
};
============================================================

============================================================
FILE: static\js\main.js
============================================================
import state, { setState } from './state.js';
import { planAPI, supplierAPI, invoiceAPI, disbursementAPI } from './api.js';
import { DOM, showMainListView, showPlanDetailsView, showTabInMainView, openModal, closeModal, handleFormSubmit } from './ui/common.js';
import { loadPlans } from './ui/planUI.js';
import { loadSuppliers, loadSuppliersCache } from './ui/supplierUI.js';
import { loadInvoices, changeInvoicePage } from './ui/invoiceUI.js';
import { loadDisbursements } from './ui/disbursementUI.js';

// --- MAIN FUNCTION TO LOAD PLAN DETAILS ---
export async function loadPlanDetails(planId) {
    showPlanDetailsView();
    const planDetailsTitle = document.getElementById('plan-details-title');
    const planDetailsDescription = document.getElementById('plan-details-description');
    
    planDetailsTitle.textContent = "Äang táº£i chi tiáº¿t káº¿ hoáº¡ch...";
    planDetailsDescription.textContent = "";

    try {
        const planData = await planAPI.getById(planId);
        setState({ selectedPlan: planData });
        
        planDetailsTitle.textContent = `Chi tiáº¿t cho Káº¿ hoáº¡ch: ${planData.name}`;
        planDetailsDescription.textContent = planData.description || '';
        
        // Táº£i hÃ³a Ä‘Æ¡n vÃ  giáº£i ngÃ¢n song song
        await Promise.all([
            loadInvoices(planId),
            loadDisbursements(planId)
        ]);

    } catch (e) {
        planDetailsTitle.textContent = "Lá»—i táº£i chi tiáº¿t káº¿ hoáº¡ch";
        console.error(e);
    }
}

// --- EVENT LISTENERS ---
function setupEventListeners() {
    // Navigation
    DOM.navPlans.addEventListener('click', () => {
        showMainListView();
        showTabInMainView('plan-management-view');
        loadPlans();
    });

    DOM.navSuppliers.addEventListener('click', () => {
        showMainListView();
        showTabInMainView('supplier-management-view');
        loadSuppliers();
    });

    document.getElementById('back-to-list-btn').addEventListener('click', () => {
        showMainListView();
        showTabInMainView('plan-management-view');
        loadPlans();
    });

    // Add buttons
    document.getElementById('add-plan-btn').addEventListener('click', () => openModal('plan'));
    document.getElementById('add-supplier-btn').addEventListener('click', () => openModal('supplier'));
    document.getElementById('add-invoice-btn').addEventListener('click', () => openModal('invoice'));
    document.getElementById('add-disbursement-btn').addEventListener('click', () => openModal('disbursement'));

    // Modal
    document.getElementById('close-modal-btn').addEventListener('click', closeModal);
    DOM.modal.addEventListener('click', e => { if(e.target === DOM.modal) closeModal(); });
    DOM.entityForm.addEventListener('submit', handleFormSubmit);

    document.getElementById('generate-schedule-btn-auto').addEventListener('click', async () => {
        if (!state.selectedPlan || !state.selectedPlan.id) return;
        const plan = state.selectedPlan;
        if (confirm(`Táº¡o/Cáº­p nháº­t lá»‹ch tráº£ lÃ£i cho káº¿ hoáº¡ch "${plan.name}"? Lá»‹ch cÅ© (náº¿u cÃ³) sáº½ bá»‹ xÃ³a.`)) {
            try {
                const result = await planAPI.generateSchedule(plan.id);
                alert(result.message);
                loadPlanDetails(plan.id);
            } catch (e) { alert(`Lá»—i: ${e.message}`); }
        }
    });

    document.getElementById('delete-schedule-btn-auto').addEventListener('click', async () => {
        if (!state.selectedPlan || !state.selectedPlan.id) return;
        const plan = state.selectedPlan;
        if (confirm(`XÃ³a toÃ n bá»™ lá»‹ch tráº£ lÃ£i cá»§a káº¿ hoáº¡ch "${plan.name}"?`)) {
            try {
                const result = await planAPI.deleteSchedule(plan.id);
                alert(result.message);
                loadPlanDetails(plan.id);
            } catch (e) { alert(`Lá»—i: ${e.message}`); }
        }
    });


    // Delegated events for tables
    document.body.addEventListener('click', async (event) => {
        const target = event.target;
        
        // View plan details
        if (target.matches('.view-details-link')) {
            event.preventDefault();
            loadPlanDetails(target.closest('tr').dataset.id);
        }

        // Pagination for invoices
        const paginationBtn = target.closest('.pagination-btn');
        if (paginationBtn) {
            changeInvoicePage(parseInt(paginationBtn.dataset.page));
        }

        // Generic Edit/Delete buttons
        const iconBtn = target.closest('.icon-btn');
        if (iconBtn) {
            const row = iconBtn.closest('tr');
            if(!row) return;

            const id = row.dataset.id;
            const type = row.dataset.type;

            if (iconBtn.classList.contains('edit-btn')) {
                try {
                    let data;
                    if (type === 'plan') data = await planAPI.getById(id);
                    else if (type === 'supplier') data = await supplierAPI.getById(id);
                    else if (type === 'invoice') data = await invoiceAPI.getById(id);
                    else if (type === 'disbursement') data = await disbursementAPI.getById(id);
                    
                    if(data) openModal(type, data);

                } catch(e) { alert(e.message); }
            }
            
            if (iconBtn.classList.contains('delete-btn')) {
                if (confirm(`Báº¡n cháº¯c cháº¯n muá»‘n xÃ³a má»¥c (ID: ${id}) nÃ y?`)) {
                    try {
                        if (type === 'plan') await planAPI.delete(id);
                        else if (type === 'supplier') { await supplierAPI.delete(id); loadSuppliersCache(); }
                        else if (type === 'invoice') await invoiceAPI.delete(id);
                        else if (type === 'disbursement') await disbursementAPI.delete(id);
                        
                        // Reload relevant data
                        if (type === 'plan' || type === 'supplier') {
                             loadPlans();
                             loadSuppliers();
                        }
                        else if (type === 'invoice' || type === 'disbursement') {
                            loadPlanDetails(state.selectedPlan.id);
                        }

                    } catch(e) { alert(e.message); }
                }
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', () => {
    setupEventListeners();
    showMainListView();
    showTabInMainView('plan-management-view');
    loadPlans();
    loadSuppliersCache();
});
============================================================

============================================================
FILE: static\js\state.js
============================================================
const state = {
    currentEditingId: null,
    currentEntityType: null,
    selectedPlan: null,
    
    // Cache
    suppliersCache: [],
    
    // Pagination cho hÃ³a Ä‘Æ¡n
    invoicePagination: {
        currentPage: 1,
        invoicesPerPage: 5,
        allInvoices: []
    }
};

export function setState(newState) {
    Object.assign(state, newState);
}

export default state;
============================================================

============================================================
FILE: static\js\ui\common.js
============================================================
import state, { setState } from '../state.js';
import { getPlanFormHtml, handlePlanSubmit } from './planUI.js';
import { getSupplierFormHtml, handleSupplierSubmit } from './supplierUI.js';
import { getInvoiceFormHtml, handleInvoiceSubmit } from './invoiceUI.js';
import { getDisbursementFormHtml, handleDisbursementSubmit } from './disbursementUI.js';

export const DOM = {
    mainListView: document.getElementById('main-list-view'),
    planDetailsView: document.getElementById('plan-details-view'),
    modal: document.getElementById('entity-modal'),
    entityForm: document.getElementById('entity-form'),
    modalTitle: document.getElementById('modal-title'),
    planManagementView: document.getElementById('plan-management-view'),
    supplierManagementView: document.getElementById('supplier-management-view'),
    navPlans: document.getElementById('nav-plans'),
    navSuppliers: document.getElementById('nav-suppliers'),
};

export function formatCurrency(amount) {
    if (amount === null || amount === undefined) return '';
    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
}

export function formatDate(dateString) {
    if (!dateString) return '';
    return new Date(dateString + 'T00:00:00').toLocaleDateString('vi-VN');
}

export function showMainListView() {
    DOM.mainListView.style.display = 'block';
    DOM.planDetailsView.style.display = 'none';
    setState({ selectedPlan: null });
}

export function showPlanDetailsView() {
    DOM.mainListView.style.display = 'none';
    DOM.planDetailsView.style.display = 'block';
}

export function showTabInMainView(viewId) {
    if (DOM.planManagementView) DOM.planManagementView.style.display = (viewId === 'plan-management-view') ? 'block' : 'none';
    if (DOM.supplierManagementView) DOM.supplierManagementView.style.display = (viewId === 'supplier-management-view') ? 'block' : 'none';
    if (DOM.navPlans) DOM.navPlans.classList.toggle('active', viewId === 'plan-management-view');
    if (DOM.navSuppliers) DOM.navSuppliers.classList.toggle('active', viewId === 'supplier-management-view');
}

export function closeModal() {
    DOM.modal.classList.remove('visible');
    setTimeout(() => {
        DOM.modal.classList.add('hidden');
        DOM.entityForm.reset();
        setState({ currentEditingId: null, currentEntityType: null });
    }, 300);
}

export function openModal(type, entity = null) {
    setState({
        currentEntityType: type,
        currentEditingId: entity ? entity.id : null
    });
    
    let formHtml = '';
    let title = '';

    switch (type) {
        case 'plan':
            title = entity ? 'Sá»­a Káº¿ hoáº¡ch' : 'ThÃªm Káº¿ hoáº¡ch';
            formHtml = getPlanFormHtml(entity);
            break;
        case 'supplier':
            title = entity ? 'Sá»­a NhÃ  Cung Cáº¥p' : 'ThÃªm NCC';
            formHtml = getSupplierFormHtml(entity);
            break;
        case 'invoice':
            title = entity ? 'Sá»­a HÃ³a Ä‘Æ¡n' : 'ThÃªm HÃ³a Ä‘Æ¡n';
            formHtml = getInvoiceFormHtml(entity);
            break;
        case 'disbursement':
            title = entity ? 'Sá»­a Giáº£i NgÃ¢n' : 'ThÃªm Giáº£i NgÃ¢n';
            formHtml = getDisbursementFormHtml(entity);
            break;

    }

    DOM.modalTitle.textContent = title;
    DOM.entityForm.innerHTML = formHtml;
    DOM.modal.classList.remove('hidden');
    setTimeout(() => DOM.modal.classList.add('visible'), 10);
}

export async function handleFormSubmit(event) {
    event.preventDefault();
    switch (state.currentEntityType) {
        case 'plan':
            await handlePlanSubmit(event.target);
            break;
        case 'supplier':
            await handleSupplierSubmit(event.target);
            break;
        case 'invoice':
            await handleInvoiceSubmit(event.target);
            break;

        case 'disbursement':
            await handleDisbursementSubmit(event.target);
            break;

    }
}
============================================================

============================================================
FILE: static\js\ui\disbursementUI.js
============================================================
import { disbursementAPI } from '../api.js';
import state, { setState } from '../state.js';
import { formatCurrency, formatDate, closeModal } from './common.js';
import { loadPlanDetails } from '../main.js';

const tableContainer = document.getElementById('disbursements-table-container');

function renderDisbursementsTable(disbursements) {
    if (!disbursements || disbursements.length === 0) {
        tableContainer.innerHTML = '<p>ChÆ°a cÃ³ lá»‹ch tráº£ lÃ£i nÃ o. HÃ£y nháº¥n "Táº¡o Lá»‹ch Tá»± Äá»™ng".</p>';
        return;
    }

    const totalInterestAmount = disbursements.reduce((sum, d) => sum + parseFloat(d.interest_amount || 0), 0);

    let tableHtml = `
        <table>
            <thead>
                <tr>
                    <th>NgÃ y Ä‘áº¿n háº¡n tráº£ lÃ£i</th>
                    <th>Sá»‘ tiá»n lÃ£i</th>
                    <th>NgÃ y thá»±c tráº£</th>
                    <th class="actions">HÃ nh Ä‘á»™ng</th>
                </tr>
            </thead>
            <tbody>`;

    disbursements.sort((a,b) => new Date(a.interest_due_date) - new Date(b.interest_due_date)).forEach(d => {
        tableHtml += `
            <tr data-id="${d.id}" data-type="disbursement">
                <td>${formatDate(d.interest_due_date)}</td>
                <td>${formatCurrency(d.interest_amount)}</td>
                <td>${formatDate(d.actual_date)}</td>
                <td class="actions">
                    <button class="icon-btn edit-btn" title="Cáº­p nháº­t tráº£ lÃ£i"><span class="material-icons">edit</span></button>
                    <button class="icon-btn delete-btn" title="XÃ³a"><span class="material-icons">delete</span></button>
                </td>
            </tr>`;
    });
    
    tableHtml += `</tbody>
        <tfoot>
            <tr style="font-weight: bold; background-color: #f5f5f5;">
                <td style="text-align: right;">Tá»•ng lÃ£i Ä‘Ã£ tráº£:</td>
                <td>${formatCurrency(totalInterestAmount)}</td>
                <td colspan="2"></td>
            </tr>
        </tfoot>
    </table>`;
    tableContainer.innerHTML = tableHtml;
}

export async function loadDisbursements(planId) {
    tableContainer.innerHTML = '<p>Äang táº£i lá»‹ch tráº£ lÃ£i...</p>';
    try {
        const disbursements = await disbursementAPI.getByPlanId(planId);
        renderDisbursementsTable(disbursements);
    } catch (e) {
        tableContainer.innerHTML = `<p style="color: red;">Lá»—i táº£i lá»‹ch tráº£ lÃ£i: ${e.message}</p>`;
    }
}

// HÃ m táº¡o HTML cho form
export function getDisbursementFormHtml(d) {
    return `
        <input type="hidden" name="plan_id" value="${d ? d.plan_id : state.selectedPlan.id}">
        
        <div class="form-group">
            <label>NgÃ y Ä‘áº¿n háº¡n tráº£ lÃ£i *</label>
            <input type="date" name="interest_due_date" required value="${d?.interest_due_date || ''}">
        </div>
        <div class="form-group">
            <label>Sá»‘ tiá»n lÃ£i</label>
            <input type="number" step="any" name="interest_amount" placeholder="Äá»ƒ trá»‘ng náº¿u chÆ°a cÃ³" value="${d?.interest_amount || ''}">
        </div>
        <div class="form-group">
            <label>NgÃ y thá»±c tráº£</label>
            <input type="date" name="actual_date" value="${d?.actual_date || ''}">
        </div>

        <div class="modal-footer"><button type="submit" class="btn btn-primary">LÆ°u</button></div>
    `;
}

// HÃ m xá»­ lÃ½ submit form
export async function handleDisbursementSubmit(form) {
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    const id = state.currentEditingId;

    // Chuyá»ƒn Ä‘á»•i cÃ¡c trÆ°á»ng sá»‘ vÃ  null náº¿u rá»—ng
    const fieldsToConvert = ['interest_amount'];
    for (const key of fieldsToConvert) {
        if (data[key] === '' || data[key] === null) {
            data[key] = null;
        } else {
            data[key] = Number(data[key]);
        }
    }
    // Chuyá»ƒn Ä‘á»•i ngÃ y rá»—ng
    const dateFields = ['interest_due_date', 'actual_date'];
    for (const key of dateFields) {
        if (data[key] === '') {
            data[key] = null;
        }
    }

    try {
        if (id) {
            // Khi cáº­p nháº­t, chá»‰ gá»­i cÃ¡c trÆ°á»ng Ä‘Æ°á»£c phÃ©p trong schema Update
            const updateData = {
                interest_due_date: data.interest_due_date,
                interest_amount: data.interest_amount,
                actual_date: data.actual_date
            };
            await disbursementAPI.update(id, updateData);
        } else {
            await disbursementAPI.create(data);
        }
        closeModal();
        loadPlanDetails(state.selectedPlan.id);
    } catch (error) {
        alert(`Lá»—i: ${error.message}`);
    }
}
============================================================

============================================================
FILE: static\js\ui\invoiceUI.js
============================================================
// File: static/js/ui/invoiceUI.js
// Logic UI cho HÃ³a Ä‘Æ¡n

import { invoiceAPI } from '../api.js';
import state, { setState } from '../state.js';
import { formatCurrency, formatDate, closeModal } from './common.js';
import { loadPlanDetails } from '../main.js'; // Import hÃ m load chÃ­nh

const tableContainer = document.getElementById('invoices-table-container');

function renderInvoicesTable() {
    const { allInvoices, currentPage, invoicesPerPage } = state.invoicePagination;

    if (!allInvoices || allInvoices.length === 0) {
        tableContainer.innerHTML = '<p>ChÆ°a cÃ³ hÃ³a Ä‘Æ¡n nÃ o cho káº¿ hoáº¡ch nÃ y.</p>';
        return;
    }
    
    const totalValue = allInvoices.reduce((sum, inv) => sum + parseFloat(inv.total_value || 0), 0);
    const totalPages = Math.ceil(allInvoices.length / invoicesPerPage);
    const paginatedInvoices = allInvoices.slice((currentPage - 1) * invoicesPerPage, currentPage * invoicesPerPage);
    
    // NÃºt phÃ¢n trang Ä‘Æ°á»£c táº¡o dÆ°á»›i dáº¡ng chuá»—i HTML Ä‘á»ƒ dá»… dÃ ng gÃ¡n sá»± kiá»‡n sau nÃ y
    const paginationControls = totalPages > 1 ? `
        <div class="pagination" style="margin-top: 16px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 16px;">
            <button class="btn btn-secondary pagination-btn" data-page="${currentPage - 1}" ${currentPage === 1 ? 'disabled' : ''}>TrÆ°á»›c</button>
            <span style="font-weight: 500;">Trang ${currentPage} / ${totalPages}</span>
            <button class="btn btn-secondary pagination-btn" data-page="${currentPage + 1}" ${currentPage === totalPages ? 'disabled' : ''}>Sau</button>
        </div>` : '';

    tableContainer.innerHTML = `
        <table>
            <thead><tr><th>Sá»‘ HÄ</th><th>NgÃ y HÄ</th><th>NCC</th><th>GiÃ¡ trá»‹</th><th class="actions">HÃ nh Ä‘á»™ng</th></tr></thead>
            <tbody>
            ${paginatedInvoices.map(inv => `
                <tr data-id="${inv.id}" data-type="invoice">
                    <td>${inv.invoice_number}</td><td>${formatDate(inv.issue_date)}</td>
                    <td>${inv.supplier?.name || 'N/A'}</td><td>${formatCurrency(inv.total_value)}</td>
                    <td class="actions">
                        <button class="icon-btn edit-btn" title="Sá»­a"><span class="material-icons">edit</span></button>
                        <button class="icon-btn delete-btn" title="XÃ³a"><span class="material-icons">delete</span></button>
                    </td>
                </tr>`).join('')}
            </tbody>
            <tfoot>
                <tr style="font-weight: bold; background-color: #f5f5f5;">
                    <td colspan="3" style="text-align: right;">Tá»•ng cá»™ng:</td>
                    <td>${formatCurrency(totalValue)}</td><td></td>
                </tr>
            </tfoot>
        </table>
        ${paginationControls}`;
}

export function changeInvoicePage(newPage) {
    const { allInvoices, invoicesPerPage } = state.invoicePagination;
    const totalPages = Math.ceil(allInvoices.length / invoicesPerPage);
    if (newPage >= 1 && newPage <= totalPages) {
        setState({ invoicePagination: { ...state.invoicePagination, currentPage: newPage } });
        renderInvoicesTable();
    }
}

export async function loadInvoices(planId) {
    tableContainer.innerHTML = '<p>Äang táº£i hÃ³a Ä‘Æ¡n...</p>';
    try {
        const invoices = await invoiceAPI.getByPlanId(planId);
        setState({ invoicePagination: { ...state.invoicePagination, allInvoices: invoices, currentPage: 1 } });
        renderInvoicesTable();
    } catch (e) {
        tableContainer.innerHTML = `<p style="color: red;">Lá»—i táº£i hÃ³a Ä‘Æ¡n: ${e.message}</p>`;
    }
}

export function getInvoiceFormHtml(inv) {
    const supplierOptions = state.suppliersCache.map(s => 
        `<option value="${s.id}" ${inv && inv.supplier_id === s.id ? 'selected' : ''}>${s.name}</option>`
    ).join('');

    return `
        <input type="hidden" name="plan_id" value="${state.selectedPlan.id}">
        <div class="form-group"><label>Sá»‘ hÃ³a Ä‘Æ¡n *</label><input type="text" name="invoice_number" required value="${inv ? inv.invoice_number : ''}"></div>
        <div class="form-group"><label>NgÃ y hÃ³a Ä‘Æ¡n *</label><input type="date" name="issue_date" required value="${inv ? inv.issue_date : ''}"></div>
        <div class="form-group"><label>GiÃ¡ trá»‹ *</label><input type="number" step="any" name="total_value" required value="${inv ? inv.total_value : ''}"></div>
        <div class="form-group"><label>NhÃ  cung cáº¥p *</label><select name="supplier_id" required>${supplierOptions}</select></div>
        <div class="form-group"><label>Tráº¡ng thÃ¡i</label>
            <select name="status">
                <option value="ChÆ°a thanh toÃ¡n" ${inv && inv.status === 'ChÆ°a thanh toÃ¡n' ? 'selected' : ''}>ChÆ°a thanh toÃ¡n</option>
                <option value="ÄÃ£ thanh toÃ¡n" ${inv && inv.status === 'ÄÃ£ thanh toÃ¡n' ? 'selected' : ''}>ÄÃ£ thanh toÃ¡n</option>
            </select>
        </div>
        <div class="modal-footer"><button type="submit" class="btn btn-primary">LÆ°u</button></div>
    `;
}

export async function handleInvoiceSubmit(form) {
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    const id = state.currentEditingId;

    try {
        if (id) {
            await invoiceAPI.update(id, data);
        } else {
            await invoiceAPI.create(data);
        }
        closeModal();
        loadPlanDetails(state.selectedPlan.id); // Táº£i láº¡i toÃ n bá»™ chi tiáº¿t káº¿ hoáº¡ch
    } catch (error) {
        alert(`Lá»—i: ${error.message}`);
    }
}
============================================================

============================================================
FILE: static\js\ui\planUI.js
============================================================
import { planAPI } from '../api.js';
import { closeModal } from './common.js';

const tableContainer = document.getElementById('plans-table-container');

function renderPlansTable(plans) {
    if (!plans || plans.length === 0) {
        tableContainer.innerHTML = '<p>ChÆ°a cÃ³ káº¿ hoáº¡ch nÃ o.</p>';
        return;
    }
    tableContainer.innerHTML = `
        <table>
            <thead><tr><th>TÃªn Káº¿ hoáº¡ch</th><th>MÃ´ táº£</th><th class="actions">HÃ nh Ä‘á»™ng</th></tr></thead>
            <tbody>
                ${plans.map(p => `
                    <tr data-id="${p.id}" data-type="plan">
                        <td><a href="#" class="view-details-link">${p.name}</a></td>
                        <td>${p.description || ''}</td>
                        <td class="actions">
                            <button class="icon-btn edit-btn" title="Sá»­a"><span class="material-icons">edit</span></button>
                            <button class="icon-btn delete-btn" title="XÃ³a"><span class="material-icons">delete</span></button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>`;
}

export async function loadPlans() {
    tableContainer.innerHTML = '<p>Äang táº£i...</p>';
    try {
        const plans = await planAPI.getAll();
        renderPlansTable(plans);
    } catch (e) {
        tableContainer.innerHTML = `<p style="color: red;">Lá»—i táº£i káº¿ hoáº¡ch: ${e.message}</p>`;
    }
}


export function getPlanFormHtml(p) {

    const idInput = p ? `<input type="hidden" name="id" value="${p.id}">` : '';

    return `
        ${idInput} 
        <div class="form-group"><label>TÃªn Káº¿ hoáº¡ch *</label><input type="text" name="name" required value="${p ? p.name : ''}"></div>
        <div class="form-group"><label>MÃ´ táº£</label><textarea name="description" rows="3">${p ? p.description || '' : ''}</textarea></div>
        <div class="form-group"><label>NgÃ y tráº£ lÃ£i Ä‘á»‹nh ká»³ *</label><input type="number" name="periodic_interest_day" required min="1" max="31" value="${p ? p.periodic_interest_day : '25'}"></div>
        
        <hr>
        <h4>ThÃ´ng tin Khoáº£n vay</h4>
        <div class="form-group"><label>NgÃ y thá»±c táº¿ vay</label><input type="date" name="actual_date" value="${p && p.actual_date ? p.actual_date : ''}"></div>
        <div class="form-group"><label>NgÃ y Ä‘Ã¡o háº¡n (tráº£ gá»‘c)</label><input type="date" name="principal_due_date" value="${p && p.principal_due_date ? p.principal_due_date : ''}"></div>
        <div class="form-group"><label>NgÃ¢n hÃ ng</label><input type="text" name="bank_name" value="${p ? p.bank_name || '' : ''}"></div>
        <div class="form-group"><label>Sá»‘ HÄ TÃ­n dá»¥ng</label><input type="text" name="loan_contract_number" value="${p ? p.loan_contract_number || '' : ''}"></div>

        <div class="modal-footer"><button type="submit" class="btn btn-primary">LÆ°u</button></div>
    `;
}

export async function handlePlanSubmit(form) {
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Láº¥y ID tá»« form data
    const id = data.id;

    // Chuyá»ƒn Ä‘á»•i cÃ¡c trÆ°á»ng date rá»—ng thÃ nh null Ä‘á»ƒ API khÃ´ng bÃ¡o lá»—i
    const dateFields = ['actual_date', 'principal_due_date'];
    dateFields.forEach(field => {
        if (data[field] === '') {
            data[field] = null;
        }
    });

    try {
        if (id) {
            // ÄÃ£ cÃ³ id, gá»i API update
            await planAPI.update(id, data);
        } else {
            // KhÃ´ng cÃ³ id, gá»i API create
            await planAPI.create(data);
        }
        closeModal();
        loadPlans();
    } catch (error) {
        alert(`Lá»—i: ${error.message}`);
    }
}
============================================================

============================================================
FILE: static\js\ui\supplierUI.js
============================================================
import { supplierAPI } from '../api.js';
import { closeModal } from './common.js';
import state, { setState } from '../state.js';

const tableContainer = document.getElementById('suppliers-table-container');

function renderSuppliersTable(suppliers) {
    if (!suppliers || suppliers.length === 0) {
        tableContainer.innerHTML = '<p>ChÆ°a cÃ³ nhÃ  cung cáº¥p nÃ o.</p>';
        return;
    }
    tableContainer.innerHTML = `
        <table>
            <thead><tr><th>TÃªn NCC</th><th>LiÃªn há»‡</th><th class="actions">HÃ nh Ä‘á»™ng</th></tr></thead>
            <tbody>
                ${suppliers.map(s => `
                    <tr data-id="${s.id}" data-type="supplier">
                        <td>${s.name}</td>
                        <td>${s.contact_info || ''}</td>
                        <td class="actions">
                            <button class="icon-btn edit-btn" title="Sá»­a"><span class="material-icons">edit</span></button>
                            <button class="icon-btn delete-btn" title="XÃ³a"><span class="material-icons">delete</span></button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>`;
}

export async function loadSuppliers() {
    tableContainer.innerHTML = '<p>Äang táº£i...</p>';
    try {
        const suppliers = await supplierAPI.getAll();
        renderSuppliersTable(suppliers);
    } catch (e) {
        tableContainer.innerHTML = `<p style="color: red;">Lá»—i táº£i NCC: ${e.message}</p>`;
    }
}

export async function loadSuppliersCache() {
    try {
        const suppliers = await supplierAPI.getAll();
        setState({ suppliersCache: suppliers });
    } catch(e) { 
        console.error("Lá»—i táº£i cache NCC:", e); 
    }
}

export function getSupplierFormHtml(s) {
    return `
        <div class="form-group"><label>TÃªn NCC *</label><input type="text" name="name" required value="${s ? s.name : ''}"></div>
        <div class="form-group"><label>LiÃªn há»‡</label><textarea name="contact_info" rows="3">${s ? s.contact_info || '' : ''}</textarea></div>
        <div class="modal-footer"><button type="submit" class="btn btn-primary">LÆ°u</button></div>
    `;
}

export async function handleSupplierSubmit(form) {
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    const id = state.currentEditingId;

    try {
        if (id) {
            await supplierAPI.update(id, data);
        } else {
            await supplierAPI.create(data);
        }
        closeModal();
        loadSuppliers();
        loadSuppliersCache(); // Cáº­p nháº­t láº¡i cache
    } catch (error) {
        alert(`Lá»—i: ${error.message}`);
    }
}
============================================================


ğŸ“Š THá»NG KÃŠ
------------------------------
Tá»•ng sá»‘ file: 37
File code: 33
CÃ¡c loáº¡i file code:
  .css: 1 file
  .js: 8 file
  .md: 1 file
  .py: 21 file
  .txt: 2 file
